
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">

    <title>Your Code Is Too Clever &mdash; Jack Hsu</title>
    
    <meta name="author" content="Jack Hsu">
    <meta name="viewport" content="initial-scale=1, maximum-scale=1">

    <link rel="shortcut icon" href="/images/profile-2.jpg">
    <link rel="apple-touch-icon" href="/images/profile-2.jpg">

    <link rel="alternate" type="application/rss+xml" title="Jack Hsu's Blog" href="http://jaysoo.ca/feed.xml">


    <link href='https://fonts.googleapis.com/css?family=Crimson+Text:400,600,400italic|Raleway:400' rel='stylesheet' type='text/css'>

    <script src="https://use.fontawesome.com/98868726f0.js"></script>

    <link type="text/css" rel="stylesheet" href="/assets/application.css">
  </head>
  <body>
    <div id="fb-root"></div>

    <script>(function(d, s, id) {
      var js, fjs = d.getElementsByTagName(s)[0];
      if (d.getElementById(id)) return;
      js = d.createElement(s); js.id = id;
      js.src = "//connect.facebook.net/en_US/all.js#xfbml=1&appId=152515241476494";
      fjs.parentNode.insertBefore(js, fjs);
    }(document, 'script', 'facebook-jssdk'));</script>

    <nav class="navbar navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container-fluid">
          <button type="button" class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
            <i class="fa fa-bars"></i>
          </button>
          <div class="brand" >
            <img src="/images/profile-2.jpg" alt="" />
            <a href="/">
              Jack Hsu
            </a>
          </div>
          <div class="twitter-follow">
            <a href="https://twitter.com/jay_soo" class="twitter-follow-button" data-show-count="true" data-lang="en">Follow @jay_soo</a>
            <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
            <a class="github-button" href="https://github.com/jaysoo" data-count-href="/jaysoo/followers" data-count-api="/users/jaysoo#followers" data-count-aria-label="# followers on GitHub" aria-label="Follow @jaysoo on GitHub">Follow @jaysoo</a>
            <script async defer id="github-bjs" src="https://buttons.github.io/buttons.js"></script>
          </div>
          <div class="nav-collapse collapse">
            <ul class="nav">
              
              
              


  
    
    	
    	<li><a href="/archive/">Archive</a></li>
    	
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
    	
    	<li><a href="/tags/">Tags</a></li>
    	
    
  
    
  
    
  



              <li>
                <a href="http://feeds.feedburner.com/jaysoo/Trwf">
                  <i class="fa fa-rss"></i>
                </a>
              </li>
            </ul>
            <form class="navbar-search pull-right" action="/search.html" method="GET">
              <input id="q" name="q" type="text" class="search-query" placeholder="Search">
            </form>
          </div>
        </div>
      </div>
    </nav>

    <div id="main">
      <div class="container-fluid">
        <div class="content">
          
<div class="page-header">
  <h1>
    Your Code Is Too Clever
    
</h1>
</div>

<div class="row">
  <div class="span8">
    <div class="post-body">
      <p>As programmers we are often to <a href="http://en.wikipedia.org/wiki/KISS_principle">keep things simple</a>, and not to be too clever. While I agree with these principles most of the time, I hope that they are not used as an excuse to avoid finding better solutions for our problems.</p>
<p>How do we define <em>too clever</em>? If we read a code that we can't understand right away, does it mean it's too clever?</p>
<p>Let's take a look at one of the most clever use of <em>case </em>label fall-through in the history of Computer Science: the <a href="http://swtch.com/duffs-device/td-1983.txt">Duff's device</a>.</p>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="n">dsend</span><span class="p">(</span><span class="n">to</span><span class="p">,</span> <span class="n">from</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span>
<span class="kt">char</span> <span class="o">*</span><span class="n">to</span><span class="p">,</span> <span class="o">*</span><span class="n">from</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">count</span><span class="p">;</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="p">(</span><span class="n">count</span> <span class="o">+</span> <span class="mi">7</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
  <span class="k">switch</span> <span class="p">(</span><span class="n">count</span> <span class="o">%</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">case</span> <span class="mi">0</span><span class="p">:</span> <span class="k">do</span> <span class="p">{</span> <span class="o">*</span><span class="n">to</span> <span class="o">=</span> <span class="o">*</span><span class="n">from</span><span class="o">++</span><span class="p">;</span>
  <span class="k">case</span> <span class="mi">7</span><span class="p">:</span>      <span class="o">*</span><span class="n">to</span> <span class="o">=</span> <span class="o">*</span><span class="n">from</span><span class="o">++</span><span class="p">;</span>
  <span class="k">case</span> <span class="mi">6</span><span class="p">:</span>      <span class="o">*</span><span class="n">to</span> <span class="o">=</span> <span class="o">*</span><span class="n">from</span><span class="o">++</span><span class="p">;</span>
  <span class="k">case</span> <span class="mi">5</span><span class="p">:</span>      <span class="o">*</span><span class="n">to</span> <span class="o">=</span> <span class="o">*</span><span class="n">from</span><span class="o">++</span><span class="p">;</span>
  <span class="k">case</span> <span class="mi">4</span><span class="p">:</span>      <span class="o">*</span><span class="n">to</span> <span class="o">=</span> <span class="o">*</span><span class="n">from</span><span class="o">++</span><span class="p">;</span>
  <span class="k">case</span> <span class="mi">3</span><span class="p">:</span>      <span class="o">*</span><span class="n">to</span> <span class="o">=</span> <span class="o">*</span><span class="n">from</span><span class="o">++</span><span class="p">;</span>
  <span class="k">case</span> <span class="mi">2</span><span class="p">:</span>      <span class="o">*</span><span class="n">to</span> <span class="o">=</span> <span class="o">*</span><span class="n">from</span><span class="o">++</span><span class="p">;</span>
  <span class="k">case</span> <span class="mi">1</span><span class="p">:</span>      <span class="o">*</span><span class="n">to</span> <span class="o">=</span> <span class="o">*</span><span class="n">from</span><span class="o">++</span><span class="p">;</span>
         <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">n</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>Both clever and confusing, this device leverages C's relaxed specification of the <em>switch </em>statement to optimize a serial copy using <a href="http://en.wikipedia.org/wiki/Loop_unwinding">loop unwinding</a>. I can imagine most people being repulsed by the code above -- you're not alone. Even the code's discoverer said that he felt "a combination of pride and revulsion at this discovery."</p>
<p>But is Duff's device too clever? I think if you look at it in the original context (which was about real-time animation), it was a brilliant solution to the problem. That is not to say we should start using it in our everday work. Even ignoring issues with how different system architectures and compiler optimizations handle the device, is loop unwinding even useful? Most likely no. There are many ways to get your code to run faster, including new hardware.</p>
<p>How about this piece of code, found in the 3D engine of Quake III to calculate the square root of a float.</p>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="kt">float</span> <span class="n">InvSqrt</span> <span class="p">(</span><span class="kt">float</span> <span class="n">x</span><span class="p">){</span>
  <span class="kt">float</span> <span class="n">xhalf</span> <span class="o">=</span> <span class="mf">0.5</span><span class="n">f</span><span class="o">*</span><span class="n">x</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">int</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">x</span><span class="p">;</span>
  <span class="n">i</span> <span class="o">=</span> <span class="mh">0x5f3759df</span> <span class="o">-</span> <span class="p">(</span><span class="n">i</span><span class="o">&gt;&gt;</span><span class="mi">1</span><span class="p">);</span>
  <span class="n">x</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">float</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">i</span><span class="p">;</span>
  <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">*</span><span class="p">(</span><span class="mf">1.5</span><span class="n">f</span> <span class="o">-</span> <span class="n">xhalf</span><span class="o">*</span><span class="n">x</span><span class="o">*</span><span class="n">x</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">x</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<p>Notice the magical constant <code>0x5f3759df</code>. Where did that come from and what does it do? There is a brief explanation given <a href="http://www.beyond3d.com/content/articles/8/">here </a>about this constant. Basically it involves the <a href="http://en.wikipedia.org/wiki/Newton%27s_method">Newton-Raphson</a> method for approximating square roots.</p>
<p>Is this <code>InvSqrt</code> function unnecessarily clever? I'd say no, because 3D engines have always used mathematical models to draw speed and power from. This function is pretty straight-forward once you understand the math behind it. And in this case, we can't throw more hardware to increase performance, not unless we want to launch a game that can't even perform at 50% speed on the best gaming-rig currently available. (I'm reminded of <a href="http://en.wikipedia.org/wiki/Wirth%27s_law">Wirth's law</a> a little bit)</p>
<p>The point is, we need to pick and choose when to be clever. Principles and guidelines are useful, but they are not meant to be be followed 100% of the time. Aren't we, as programmers, paid for our ability to think? So think!</p>

    </div>
    <hr>
    <div class="pagination">
      <ul>
      
        <li class="prev"><a href="/2009/02/16/java-is-just-too-slow/" title="Java Is Just Too Slow">&larr; Previous</a></li>
      
        <li><a href="/archive.html">Archive</a></li>
      
        <li class="next"><a href="/2009/03/04/video-manipulation-in-firefox-3-1-using-html-5/" title="Video manipulation in Firefox 3.1 using HTML 5">Next &rarr;</a></li>
      
      </ul>
    </div>
    <hr>
    


  <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_developer = 1;
    var disqus_shortname = 'jaysoo';
    var disqus_identifier = '/2009/02/24/your-code-is-too-clever/';
    var disqus_url = 'http://jaysoo.ca/2009/02/24/your-code-is-too-clever/';
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>




  </div>

  <aside class="span4">
    <h4>Published</h4>
    <div class="box date"><span>24 February 2009</span></div>

  
    <h4>Tags</h4>
    <ul class="box tag_box">
    
    


  
     
    	<li><a href="/tags.html#clever-ref">clever <span>1</span></a></li>
     
    	<li><a href="/tags.html#c-ref">c <span>1</span></a></li>
     
    	<li><a href="/tags.html#graphics-ref">graphics <span>2</span></a></li>
     
    	<li><a href="/tags.html#mathematics-ref">mathematics <span>1</span></a></li>
     
    	<li><a href="/tags.html#approximation-ref">approximation <span>1</span></a></li>
    
  



    </ul>
  

    <h4>Share</h4>
    <div class="box">
      <a href="https://twitter.com/share?url=http://jaysoo.ca/2009/02/24/your-code-is-too-clever/&amp;text=Your%20Code%20Is%20Too%20Clever&amp;via=jay_soo" class="twitter-share-button"{count} data-via="jay_soo" data-size="large">Tweet</a> <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
    </div>

    <h4>Related Posts</h4>
    <ul>
      
      <li><a href="/2016/08/23/why-you-need-types/">Why You Need Types</a></li>
      
      <li><a href="/2016/02/28/organizing-redux-application/">Rules For Structuring (Redux) Applications</a></li>
      
      <li><a href="/2016/01/13/functional-programming-little-ideas/">The Little Idea of Functional Programming</a></li>
      
      <li><a href="/2016/01/03/managing-processes-in-redux-using-sagas/">Managing Side Effects In React + Redux Using Sagas</a></li>
      
      <li><a href="/2015/11/21/avoid-unnecessary-indirection/">Avoid Unnecessary Indirection</a></li>
      
    </ul>
  </aside>
</div>


        </div>
      </div>
    </div> <!-- /#main -->

    <footer class="page-footer">
      <div class="container-fluid">
        <h3>About Jack <i class="fa fa-asterisk"></i></h3>

        <p>
          I am a Toronto-based software engineer. My interests are in client-side
          applications, Functional Programming, and Reactive Systems.
          You may reach me via email at jack.hsu@gmail.com.
        </p>

        <ul class="social-links">
          <li>
            <a href="https://twitter.com/jay_soo"><i class="fa fa-twitter"></i></a>
          </li>
          <li>
            <a href="https://github.com/jaysoo"><i class="fa fa-github"></i></a>
          </li>
          <li>
            <a href="https://linkedin.com/in/jackhsu83"><i class="fa fa-linkedin"></i></a>
          </li>
          <li>
            <a href="https://plus.google.com/+JackHsu83/"><i class="fa fa-google-plus"></i></a>
          </li>
          <li>
            <a href="https://stackoverflow.com/users/70871/jay-soo"><i class="fa fa-stack-overflow"></i></a>
          </li>
          <li>
            <a href="http://instagram.com/jaysoo3"><i class="fa fa-instagram"></i></a>
          </li>
        </ul>
        <p class="info"><small>&copy; Jack Hsu 2016</p>
      </div>
    </footer>

    


  <script>
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-300789-3']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://' : 'http://') + 'stats.g.doubleclick.net/dc.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>






    <script src="//platform.twitter.com/widgets.js" charset="utf-8"></script>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
    <script type="text/javascript" src="/assets/application.js"></script>
    
  </body>
</html>

